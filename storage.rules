rules_version = '2';

// ============================================
// DawinOS v2.0 - Firebase Storage Rules
// ============================================

service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function userId() {
      return request.auth.uid;
    }
    
    function isAdmin() {
      return request.auth.token.role == 'platform_admin';
    }
    
    function isHR() {
      return request.auth.token.role in ['platform_admin', 'hr_admin', 'hr_manager'];
    }
    
    function isFinance() {
      return request.auth.token.role in ['platform_admin', 'finance_admin', 'finance_manager'];
    }
    
    function isExecutive() {
      return request.auth.token.role in ['platform_admin', 'ceo', 'executive', 'director'];
    }
    
    function belongsToSubsidiary(subsidiaryId) {
      return request.auth.token.subsidiaryId == subsidiaryId;
    }
    
    // Validate file size (max 50MB)
    function isValidSize() {
      return request.resource.size < 50 * 1024 * 1024;
    }
    
    // Validate image type
    function isValidImageType() {
      return request.resource.contentType.matches('image/(png|jpeg|gif|webp)');
    }
    
    // Validate document type
    function isValidDocType() {
      return request.resource.contentType.matches('application/pdf');
    }
    
    // Validate spreadsheet/CSV type
    function isValidSpreadsheetType() {
      return request.resource.contentType.matches('(application/pdf|text/csv|application/vnd.ms-excel|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)');
    }

    // Validate CAD file types
    function isValidCADType() {
      return request.resource.contentType.matches('(application/acad|application/x-acad|application/autocad_dwg|image/vnd.dwg|application/dwg|application/dxf)');
    }

    // Validate file size with higher limit for CAD (max 100MB)
    function isValidLargeFileSize() {
      return request.resource.size < 100 * 1024 * 1024;
    }
    
    // ============================================
    // USER PROFILE IMAGES
    // ============================================
    
    match /users/{userId}/profile/{fileName} {
      allow read: if isAuthenticated();
      allow write: if (request.auth.uid == userId || isAdmin()) &&
        isValidSize() &&
        isValidImageType();
    }
    
    // ============================================
    // HR DOCUMENTS
    // ============================================
    
    match /hr/employees/{employeeId}/{document=**} {
      allow read: if isHR() || request.auth.uid == employeeId;
      allow write: if isHR() && isValidSize();
    }
    
    match /hr/contracts/{contractId}/{fileName} {
      allow read: if isHR();
      allow write: if isHR() && 
        isValidSize() &&
        isValidDocType();
    }
    
    match /hr/payroll/{batchId}/{fileName} {
      // Highly restricted - HR only
      allow read: if isHR() || isFinance();
      allow write: if isHR() && 
        isValidSize() &&
        isValidSpreadsheetType();
    }
    
    // ============================================
    // FINANCE DOCUMENTS
    // ============================================
    
    match /finance/statements/{batchId}/{fileName} {
      allow read: if isFinance();
      allow write: if isFinance() && 
        isValidSize() &&
        isValidSpreadsheetType();
    }
    
    match /finance/reports/{year}/{fileName} {
      allow read: if isFinance() || isAdmin();
      allow write: if isFinance() && isValidSize();
    }
    
    // ============================================
    // EXECUTIVE DOCUMENTS
    // ============================================
    
    match /executive/strategy/{docId}/{fileName} {
      allow read: if isExecutive();
      allow write: if isExecutive() && isValidSize();
    }
    
    match /executive/capital/{raiseId}/{fileName} {
      // Investor materials
      allow read: if isExecutive() || isFinance();
      allow write: if isExecutive() && isValidSize();
    }
    
    // ============================================
    // SUBSIDIARY DOCUMENTS
    // ============================================
    
    match /subsidiaries/{subsidiaryId}/{path=**} {
      allow read: if isAdmin() || belongsToSubsidiary(subsidiaryId);
      allow write: if (isAdmin() || belongsToSubsidiary(subsidiaryId)) && isValidSize();
    }
    
    // ============================================
    // KNOWLEDGE BASE
    // ============================================
    
    match /knowledge/{category}/{fileName} {
      // All authenticated users can read
      allow read: if isAuthenticated();
      // HR and admin can write
      allow write: if isHR() && isValidSize();
    }
    
    // ============================================
    // TEMPORARY UPLOADS
    // ============================================
    
    match /temp/{userId}/{fileName} {
      // Users can upload to their temp folder
      allow read: if request.auth.uid == userId;
      allow write: if request.auth.uid == userId && isValidSize();
      // Auto-deleted after 24 hours via Cloud Function
    }
    
    // ============================================
    // ORGANIZATION BRANDING & ASSETS
    // ============================================

    // Organization assets are only accessible to org members or admins
    match /organizations/{orgId}/{path=**} {
      allow read: if isAuthenticated() && (isAdmin() || belongsToSubsidiary(orgId) || orgId == 'default');
      allow write: if isAuthenticated() && isValidSize() && (isAdmin() || belongsToSubsidiary(orgId) || orgId == 'default');
    }

    // ============================================
    // PROJECT/FACILITY BRANDING ASSETS (Logos)
    // ============================================

    match /assets/logos/{projectCode}/{fileName} {
      // All authenticated users can read logos (needed for document generation)
      allow read: if isAuthenticated();
      // Authenticated users can upload logos (images only, max 5MB)
      allow write: if isAuthenticated() &&
        request.resource.size < 5 * 1024 * 1024 &&
        isValidImageType();
    }
    
    // ============================================
    // ACCOUNTABILITY DOCUMENTS
    // ============================================

    match /accountability-documents/{requisitionId}/{fileName} {
      // All authenticated users can read and write accountability documents
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() &&
        request.resource.size < 10 * 1024 * 1024; // Max 10MB as per form validation
    }

    // ============================================
    // ACTIVITY REPORTS
    // ============================================

    match /activity-reports/{requisitionId}/{level}/{fileName} {
      // All authenticated users can read and write activity reports
      // level can be 'requisition' or 'accountability'
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() &&
        request.resource.size < 50 * 1024 * 1024; // Max 50MB for reports with photos
    }

    // ============================================
    // FUNDS ACKNOWLEDGEMENT DOCUMENTS
    // ============================================

    match /funds-acknowledgements/{requisitionId}/{fileName} {
      // All authenticated users can read and write funds acknowledgement PDFs
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() &&
        request.resource.size < 10 * 1024 * 1024; // Max 10MB for PDFs
    }

    // ============================================
    // PROJECT & DESIGN ASSETS (Existing)
    // ============================================

    match /projects/{projectId}/{path=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidSize();
    }
    
    match /designs/{designId}/{path=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidSize();
    }
    
    match /clips/{clipId}/{path=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidSize();
    }

    // ============================================
    // DARWIN FINISHES - CLIENT DOCUMENTS
    // ============================================

    match /design-projects/{projectId}/client-documents/{category}/{fileName} {
      // Finishes subsidiary users can read/write
      allow read: if isAuthenticated() && belongsToSubsidiary('finishes');
      allow write: if isAuthenticated() && belongsToSubsidiary('finishes') && (
        // Reference images: 20MB limit, image types only
        (category == 'reference-images' && request.resource.size < 20 * 1024 * 1024 && isValidImageType()) ||
        // CAD drawings: 100MB limit, CAD types only
        (category == 'cad-drawings' && isValidLargeFileSize() && isValidCADType()) ||
        // PDF plans: 50MB limit, PDF only
        (category == 'pdf-plans' && isValidSize() && isValidDocType()) ||
        // Design briefs: 10MB limit, PDF only
        (category == 'design-briefs' && request.resource.size < 10 * 1024 * 1024 && isValidDocType()) ||
        // Other: 50MB limit, any type
        (category == 'other' && isValidSize())
      );
    }

    // ============================================
    // DARWIN FINISHES - DESIGN DELIVERABLES (Existing)
    // ============================================

    match /design-projects/{projectId}/items/{itemId}/deliverables/{stage}/{type}/{fileName} {
      allow read: if isAuthenticated() && belongsToSubsidiary('finishes');
      allow write: if isAuthenticated() && belongsToSubsidiary('finishes') && isValidLargeFileSize();
    }

    // ============================================
    // DARWIN FINISHES - DESIGN PROJECT CLIPS
    // ============================================

    match /design-projects/{projectId}/clips/{path=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidSize();
    }
  }
}
