rules_version = '2';

// ============================================
// DawinOS - Dawin Finishes
// Firestore Security Rules
// ============================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/designProjects/$(projectId)).data;
      return isAuthenticated() && (
        project.createdBy == request.auth.token.email ||
        project.assignedDesigner == request.auth.token.email ||
        project.assignedEngineer == request.auth.token.email ||
        isAdmin()
      );
    }
    
    // ============================================
    // Cutlist Processor Collections
    // ============================================
    
    // Work Instances collection
    match /workInstances/{instanceId} {
      allow read, write: if isAuthenticated();
    }
    
    // Material Mappings
    match /materialMappings/{mappingId} {
      allow read, write: if isAuthenticated();
    }
    
    // Stock Materials
    match /stockMaterials/{materialId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // Material Library Collections
    // ============================================
    
    // Global materials (admin managed)
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    match /katanaCatalogItems/{itemId} {
      allow read, write: if isAuthenticated();
    }

    // Unified Inventory (single source of truth for materials)
    match /inventoryItems/{itemId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // ============================================
    // Customer Hub Collections
    // ============================================
    
    // Customers collection
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update from authenticated users OR service accounts (for Cloud Functions)
      allow update, delete: if isAuthenticated() || request.auth == null;
      
      // Customer-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
      
      // Customer Projects subcollection (future)
      match /projects/{projectId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ============================================
    // Design Manager Collections
    // ============================================
    
    // Design Projects
    match /designProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow any authenticated user to update (for optimization, palette, etc.)
      allow update: if isAuthenticated();
      allow delete: if isProjectMember(projectId);
      
      // Project-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Project Parts Library (shared special parts across design items)
      match /projectParts/{partId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Design Items (subcollection)
      match /designItems/{itemId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
        
        // Stage History (append-only audit trail)
        match /stageHistory/{historyId} {
          allow read: if isAuthenticated();
          allow create: if isProjectMember(projectId);
          allow update, delete: if false; // Immutable audit trail
        }
        
        // Approvals
        match /approvals/{approvalId} {
          allow read: if isAuthenticated();
          allow create, delete: if isProjectMember(projectId);
          allow update: if isAuthenticated() && 
            resource.data.assignedTo == request.auth.token.email;
        }
        
        // Deliverables
        match /deliverables/{deliverableId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isProjectMember(projectId);
        }
      }
      
      // AI Analyses (project-level)
      match /aiAnalyses/{analysisId} {
        allow read: if isAuthenticated();
        allow create: if isProjectMember(projectId);
        allow update: if isAuthenticated() && 
          resource.data.requestedBy == request.auth.token.email;
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // User Management
    // ============================================
    
    // Users collection (for role-based access)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    // ============================================
    // Error Logging (Design Manager)
    // ============================================
    
    match /designManagerErrors/{errorId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // Asset Registry Collections
    // ============================================
    
    // Assets collection
    match /assets/{assetId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Features collection
    match /features/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // AI Features Collections
    // ============================================
    
    // Project Strategy (Strategy Canvas)
    match /projectStrategy/{projectId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Feature Library
    match /featureLibrary/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Design Item AI Conversations
    match /designItemConversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // AI Chat History (Strategy Research, Design Item Enhancement, etc.)
    match /aiChats/{chatId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // AI Context (change detection for AI tools)
    match /aiContext/{contextId} {
      allow read, write: if isAuthenticated();
    }
    
    // Product Roadmap
    match /roadmapProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Launch Pipeline Products
    match /launchProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Product Sync Mappings (Shopify)
    match /productSyncMappings/{mappingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Rate Limiting (managed by Cloud Functions)
    match /rateLimits/{userId} {
      allow read, write: if true; // Cloud Functions manage this
    }
    
    // System Config (Feature Library cache, etc.)
    match /systemConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions manage this
    }
    
    // ============================================
    // Design Clipper Collections
    // ============================================
    
    // Design Clips (inspiration capture from Chrome extension)
    // Uses user UID for createdBy field
    // Allow reading clips that belong to user OR are linked to a design item/project
    match /designClips/{clipId} {
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        resource.data.designItemId != null ||
        resource.data.projectId != null
      );
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
    }
    
    // ============================================
    // MATFLOW - Dawin Advisory
    // Construction Material Management
    // ============================================
    
    // Helper: Get user's organization ID
    function getUserOrg() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId;
    }
    
    // Helper: Check if user is org member
    function isOrgMember(orgId) {
      return isAuthenticated() && getUserOrg() == orgId;
    }
    
    // Helper: Check if user is MatFlow project member
    function isMatFlowProjectMember(orgId, projectId) {
      let project = get(/databases/$(database)/documents/organizations/$(orgId)/matflow_projects/$(projectId)).data;
      let userId = request.auth.uid;
      let userEmail = request.auth.token.email;
      
      return isOrgMember(orgId) && (
        project.createdBy == userId ||
        userId in project.memberIds
      );
    }
    
    // Helper: Check MatFlow capability
    function hasMatFlowCapability(orgId, projectId, capability) {
      let project = get(/databases/$(database)/documents/organizations/$(orgId)/matflow_projects/$(projectId)).data;
      let userId = request.auth.uid;
      
      // Check if user has capability in their member entry
      return userId in project.memberCapabilities && 
        capability in project.memberCapabilities[userId];
    }
    
    // ----------------------------------------
    // Global MatFlow Collections
    // ----------------------------------------
    
    // Standard Formulas - Read by all authenticated, write by admins
    match /matflow/data/formulas/{formulaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Material Rates - Read by all authenticated, write by admins
    match /matflow/data/material_rates/{rateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Role Definitions - Read by all authenticated, write by admins
    match /matflow/data/roles/{roleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Organization MatFlow Projects
    // ----------------------------------------
    
    match /organizations/{orgId}/matflow_projects/{projectId} {
      // Read: Org members can list, project members can read details
      allow list: if isOrgMember(orgId);
      allow get: if isMatFlowProjectMember(orgId, projectId);
      
      // Create: Org members can create projects
      allow create: if isOrgMember(orgId) && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Update: Project members with edit capability
      allow update: if isMatFlowProjectMember(orgId, projectId) &&
        hasMatFlowCapability(orgId, projectId, 'project:edit');
      
      // Delete: Only admins or project owners
      allow delete: if isAdmin() || 
        (isMatFlowProjectMember(orgId, projectId) && 
         resource.data.createdBy == request.auth.uid);
      
      // ----------------------------------------
      // BOQ Items Subcollection
      // ----------------------------------------
      
      match /boq_items/{itemId} {
        allow read: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:view');
        
        allow create: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:create');
        
        allow update: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:edit');
        
        allow delete: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:delete');
      }
      
      // ----------------------------------------
      // Procurement Entries Subcollection
      // ----------------------------------------
      
      match /procurement_entries/{entryId} {
        allow read: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:view');
        
        allow create: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:create');
        
        allow update: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:edit');
        
        allow delete: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:delete');
      }
      
      // ----------------------------------------
      // Parsing Jobs Subcollection
      // ----------------------------------------
      
      match /parsing_jobs/{jobId} {
        allow read: if isMatFlowProjectMember(orgId, projectId);
        
        allow create: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:import');
        
        allow update: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:import');
        
        // Jobs are never deleted, only marked as completed/failed
        allow delete: if false;
      }
    }
  }
}
