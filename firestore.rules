rules_version = '2';

// ============================================
// DawinOS - Dawin Finishes
// Firestore Security Rules
// ============================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && (
        // Super user bypass
        request.auth.token.email == 'onzimai@dawin.group'
        // Check root users collection
        || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.globalRole in ['admin', 'owner'])
        // Check organization users collection (doc ID = auth UID)
        || (exists(/databases/$(database)/documents/organizations/default/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/organizations/default/users/$(request.auth.uid)).data.globalRole in ['admin', 'owner'])
      );
    }
    
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/designProjects/$(projectId)).data;
      return isAuthenticated() && (
        project.createdBy == request.auth.token.email ||
        project.assignedDesigner == request.auth.token.email ||
        project.assignedEngineer == request.auth.token.email ||
        isAdmin()
      );
    }
    
    // ============================================
    // Cutlist Processor Collections
    // ============================================
    
    // Work Instances collection
    match /workInstances/{instanceId} {
      allow read, write: if isAuthenticated();
    }
    
    // Material Mappings
    match /materialMappings/{mappingId} {
      allow read, write: if isAuthenticated();
    }
    
    // Stock Materials
    match /stockMaterials/{materialId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // Material Library Collections
    // ============================================
    
    // Global materials (admin managed)
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    match /katanaCatalogItems/{itemId} {
      allow read, write: if isAuthenticated();
    }
    
    // Sync Requests - for triggering Katana sync via Firestore
    match /syncRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only backend functions can update (status changes)
      allow update, delete: if false;
    }
    
    // Katana Catalog - populated by sync function
    match /katanaCatalog/{itemId} {
      allow read: if isAuthenticated();
      // Only backend functions can write
      allow write: if false;
    }

    // Unified Inventory (single source of truth for materials)
    match /inventoryItems/{itemId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // ============================================
    // Customer Hub Collections
    // ============================================
    
    // Customers collection
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update from authenticated users OR service accounts (for Cloud Functions)
      allow update, delete: if isAuthenticated() || request.auth == null;
      
      // Customer-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
      
      // Customer Projects subcollection (future)
      match /projects/{projectId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ============================================
    // Design Manager Collections
    // ============================================
    
    // Design Projects
    match /designProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow any authenticated user to update (for optimization, palette, etc.)
      allow update: if isAuthenticated();
      allow delete: if isProjectMember(projectId);
      
      // Project-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Project Parts Library (shared special parts across design items)
      match /projectParts/{partId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Design Items (subcollection)
      match /designItems/{itemId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
        
        // Stage History (append-only audit trail)
        match /stageHistory/{historyId} {
          allow read: if isAuthenticated();
          allow create: if isProjectMember(projectId);
          allow update, delete: if false; // Immutable audit trail
        }
        
        // Approvals
        match /approvals/{approvalId} {
          allow read: if isAuthenticated();
          allow create, delete: if isProjectMember(projectId);
          allow update: if isAuthenticated() && 
            resource.data.assignedTo == request.auth.token.email;
        }
        
        // Deliverables
        match /deliverables/{deliverableId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isProjectMember(projectId);
        }
      }
      
      // AI Analyses (project-level)
      match /aiAnalyses/{analysisId} {
        allow read: if isAuthenticated();
        allow create: if isProjectMember(projectId);
        allow update: if isAuthenticated() && 
          resource.data.requestedBy == request.auth.token.email;
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // User Management
    // ============================================
    
    // Users collection (for role-based access)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Allow authenticated users to create their profile
      allow update, delete: if request.auth.uid == userId || isAdmin();
    }
    
    // ============================================
    // Error Logging (Design Manager)
    // ============================================
    
    match /designManagerErrors/{errorId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // Asset Registry Collections
    // ============================================
    
    // Assets collection
    match /assets/{assetId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Features collection
    match /features/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // AI Features Collections
    // ============================================
    
    // Project Strategy (Strategy Canvas)
    match /projectStrategy/{projectId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Feature Library
    match /featureLibrary/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Design Item AI Conversations
    match /designItemConversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // AI Chat History (Strategy Research, Design Item Enhancement, etc.)
    match /aiChats/{chatId} {
      // Allow read if user owns the chat OR if chat is linked to a project they can access
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.projectId != null
      );
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // AI Context (change detection for AI tools)
    match /aiContext/{contextId} {
      allow read, write: if isAuthenticated();
    }
    
    // Product Roadmap
    match /roadmapProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Launch Pipeline Products
    match /launchProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Product Sync Mappings (Shopify)
    match /productSyncMappings/{mappingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Rate Limiting (managed by Cloud Functions)
    match /rateLimits/{userId} {
      allow read, write: if true; // Cloud Functions manage this
    }
    
    // System Config (Feature Library cache, etc.)
    match /systemConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions manage this
    }
    
    // ============================================
    // Design Clipper Collections
    // ============================================
    
    // Design Clips (inspiration capture from Chrome extension)
    // Uses user UID for createdBy field
    // Allow reading all clips for inspiration search/recommendations
    match /designClips/{clipId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
    }
    
    // ============================================
    // Client Portal Collections
    // ============================================
    
    // Client Quotes - Quotes sent to clients for approval
    match /clientQuotes/{quoteId} {
      // Internal users can read/create/update quotes
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      // Allow delete only for draft quotes by authenticated users
      allow delete: if isAuthenticated() && resource.data.status == 'draft';
      
      // Activity log subcollection
      match /activity/{activityId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false; // Immutable audit trail
      }
    }
    
    // Public access for client portal (via access token)
    // Note: Security is handled by the service layer checking the token
    // This rule allows public reads when accessToken matches
    match /clientQuotes/{quoteId} {
      allow read: if resource.data.accessToken != null;
    }
    
    // Client Portal Messages
    match /clientPortalMessages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated(); // For marking as read
      allow delete: if isAdmin();
    }
    
    // Project Deliverables (drawings, models, specs)
    match /projectDeliverables/{deliverableId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Client Approval Items (materials, parts)
    match /clientApprovalItems/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Client Payments
    match /clientPayments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // SketchUp Models
    match /sketchupModels/{modelId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // MATFLOW - Dawin Advisory
    // Construction Material Management
    // ============================================
    
    // Helper: Get user's organization ID
    function getUserOrg() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId;
    }
    
    // Helper: Check if user is org member
    function isOrgMember(orgId) {
      return isAuthenticated() && getUserOrg() == orgId;
    }
    
    // Helper: Check if user is MatFlow project member
    function isMatFlowProjectMember(orgId, projectId) {
      let project = get(/databases/$(database)/documents/organizations/$(orgId)/matflow_projects/$(projectId)).data;
      let userId = request.auth.uid;
      let userEmail = request.auth.token.email;
      
      return isOrgMember(orgId) && (
        project.createdBy == userId ||
        userId in project.memberIds
      );
    }
    
    // Helper: Check MatFlow capability
    function hasMatFlowCapability(orgId, projectId, capability) {
      let project = get(/databases/$(database)/documents/organizations/$(orgId)/matflow_projects/$(projectId)).data;
      let userId = request.auth.uid;
      
      // Check if user has capability in their member entry
      return userId in project.memberCapabilities && 
        capability in project.memberCapabilities[userId];
    }
    
    // ----------------------------------------
    // Global MatFlow Collections
    // ----------------------------------------

    // Legacy MatFlow Projects (root-level collection for migration)
    match /matflow_projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();

      // Subcollections
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // Standard Formulas - Read by all authenticated, write by authenticated (for seeding)
    match /matflow/data/formulas/{formulaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Material Rates - Read by all authenticated, write by authenticated (for seeding)
    match /matflow/data/material_rates/{rateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Role Definitions - Read by all authenticated, write by authenticated (for seeding)
    match /matflow/data/roles/{roleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // ----------------------------------------
    // Organization MatFlow Projects
    // ----------------------------------------
    
    match /organizations/{orgId}/matflow_projects/{projectId} {
      // Simplified rules for development - allow authenticated users
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated();
      allow delete: if isAdmin() ||
        resource.data.createdBy == request.auth.uid;

      // ----------------------------------------
      // BOQ Items Subcollection
      // ----------------------------------------

      match /boq_items/{itemId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      // ----------------------------------------
      // Procurement Entries Subcollection
      // ----------------------------------------

      match /procurement_entries/{entryId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      // ----------------------------------------
      // Parsing Jobs Subcollection
      // ----------------------------------------

      match /parsing_jobs/{jobId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    // ----------------------------------------
    // Organization Advisory Programs (Unified)
    // ----------------------------------------

    // Note: Read access is public to support CD Portal (unauthenticated token-based access)
    match /organizations/{orgId}/advisory_programs/{programId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated();
      allow delete: if isAdmin() ||
        resource.data.createdBy == request.auth.uid;
    }

    // ----------------------------------------
    // Organization Advisory Projects (Unified)
    // Replaces matflow_projects for the unified collection
    // ----------------------------------------

    // Note: Read access is public to support CD Portal (unauthenticated token-based access)
    match /organizations/{orgId}/advisory_projects/{projectId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated();
      allow delete: if isAdmin() ||
        resource.data.createdBy == request.auth.uid;

      // ----------------------------------------
      // BOQ Items Subcollection
      // ----------------------------------------

      match /boq_items/{itemId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      // ----------------------------------------
      // Procurement Entries Subcollection
      // ----------------------------------------

      match /procurement_entries/{entryId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      // ----------------------------------------
      // Parsing Jobs Subcollection
      // ----------------------------------------

      match /parsing_jobs/{jobId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      // ----------------------------------------
      // Activity Log Subcollection
      // ----------------------------------------

      match /activityLog/{logId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // DAWIN ADVISORY PLATFORM
    // Engagement-centric architecture
    // ============================================
    
    // ----------------------------------------
    // Advisory Helper Functions
    // ----------------------------------------
    
    // Get user document for advisory
    function getAdvisoryUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check platform role
    function hasPlatformRole(role) {
      return isAuthenticated() && getAdvisoryUserDoc().platformRole == role;
    }
    
    // Check if user is platform admin
    function isPlatformAdmin() {
      return hasPlatformRole('super_admin') || hasPlatformRole('admin');
    }
    
    // Check if user is platform staff (any staff role)
    function isPlatformStaff() {
      let user = getAdvisoryUserDoc();
      return user.platformRole in ['super_admin', 'admin', 'manager', 'staff'];
    }
    
    // Get user's role in an engagement
    function getEngagementRole(engagementId) {
      let user = getAdvisoryUserDoc();
      return user.engagementRoles[engagementId];
    }
    
    // Check if user has role in engagement
    function hasEngagementRole(engagementId, allowedRoles) {
      let role = getEngagementRole(engagementId);
      return role != null && role in allowedRoles;
    }
    
    // Check if user is engagement owner or lead
    function isEngagementLeadership(engagementId) {
      return hasEngagementRole(engagementId, ['engagement_owner', 'engagement_lead']);
    }
    
    // Check if user can read engagement
    function canReadEngagement(engagementId) {
      return isPlatformAdmin() || getEngagementRole(engagementId) != null;
    }
    
    // Check if user can write to engagement
    function canWriteEngagement(engagementId) {
      return isPlatformAdmin() || hasEngagementRole(engagementId, [
        'engagement_owner', 
        'engagement_lead',
        'program_manager',
        'deal_lead',
        'portfolio_manager',
        'project_manager',
        'finance_officer',
        'compliance_officer'
      ]);
    }
    
    // Check if user can manage engagement (update settings, team)
    function canManageEngagement(engagementId) {
      return isPlatformAdmin() || isEngagementLeadership(engagementId);
    }
    
    // Check if user can approve in engagement
    function canApproveInEngagement(engagementId) {
      return hasEngagementRole(engagementId, [
        'engagement_owner',
        'engagement_lead',
        'program_manager',
        'project_manager',
        'deal_lead',
        'portfolio_manager',
        'finance_officer'
      ]);
    }
    
    // Check if user is associated with a client
    function isClientAssociated(clientId) {
      let user = getAdvisoryUserDoc();
      return user.clientAssociations != null && 
             clientId in user.clientAssociations;
    }
    
    // Check if user is associated with a funder
    function isFunderAssociated(funderId) {
      let user = getAdvisoryUserDoc();
      return user.funderAssociations != null && 
             funderId in user.funderAssociations;
    }
    
    // Validate required fields exist
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }
    
    // ----------------------------------------
    // Engagements Collection
    // ----------------------------------------
    
    match /engagements/{engagementId} {
      // Read: Team members and admins
      allow read: if canReadEngagement(engagementId);
      
      // Create: Admins and managers
      allow create: if isPlatformAdmin() || hasPlatformRole('manager');
      
      // Update: Engagement leadership and admins
      allow update: if canManageEngagement(engagementId);
      
      // Delete: Only super admins
      allow delete: if hasPlatformRole('super_admin');
      
      // ----------------------------------------
      // Funding Sources Subcollection
      // ----------------------------------------
      
      match /fundingSources/{fundingSourceId} {
        allow read: if canReadEngagement(engagementId);
        
        allow create: if canWriteEngagement(engagementId) &&
                         hasRequiredFields(request.resource.data, 
                           ['category', 'instrumentType', 'funderId', 'committedAmount']);
        
        allow update: if canWriteEngagement(engagementId);
        
        allow delete: if canManageEngagement(engagementId);
        
        // Disbursements subcollection
        match /disbursements/{disbursementId} {
          allow read: if canReadEngagement(engagementId);
          
          allow create: if canWriteEngagement(engagementId) &&
                           hasRequiredFields(request.resource.data,
                             ['requestedAmount', 'description']);
          
          allow update: if canWriteEngagement(engagementId) ||
                           // Funder can update status
                           isFunderAssociated(get(/databases/$(database)/documents/engagements/$(engagementId)/fundingSources/$(fundingSourceId)).data.funderId);
          
          allow delete: if canManageEngagement(engagementId);
        }
      }
      
      // ----------------------------------------
      // Reporting Requirements Subcollection
      // ----------------------------------------
      
      match /reportingRequirements/{requirementId} {
        allow read: if canReadEngagement(engagementId);
        allow write: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Report Submissions Subcollection
      // ----------------------------------------
      
      match /reportSubmissions/{submissionId} {
        allow read: if canReadEngagement(engagementId);
        
        allow create: if canWriteEngagement(engagementId);
        
        // Can update own submissions or if approver
        allow update: if canWriteEngagement(engagementId) ||
                         (resource.data.submittedBy == request.auth.uid);
        
        allow delete: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Covenants Subcollection
      // ----------------------------------------
      
      match /covenants/{covenantId} {
        allow read: if canReadEngagement(engagementId);
        
        allow create, update: if canManageEngagement(engagementId) ||
                                 hasEngagementRole(engagementId, ['compliance_officer', 'finance_officer']);
        
        allow delete: if canManageEngagement(engagementId);
        
        // Measurements subcollection
        match /measurements/{measurementId} {
          allow read: if canReadEngagement(engagementId);
          
          allow create: if hasEngagementRole(engagementId, [
            'engagement_owner', 'engagement_lead', 'compliance_officer', 'finance_officer'
          ]);
          
          allow update: if canManageEngagement(engagementId);
          
          allow delete: if canManageEngagement(engagementId);
        }
      }
      
      // ----------------------------------------
      // Approval Requests Subcollection
      // ----------------------------------------
      
      match /approvalRequests/{requestId} {
        allow read: if canReadEngagement(engagementId);
        
        // Anyone on the team can create approval requests
        allow create: if canWriteEngagement(engagementId) ||
                         hasEngagementRole(engagementId, ['team_member', 'quantity_surveyor', 'site_manager']);
        
        // Can update if you're an approver or the requester (for cancellation)
        allow update: if canApproveInEngagement(engagementId) ||
                         resource.data.requestedBy == request.auth.uid;
        
        allow delete: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Documents Subcollection
      // ----------------------------------------
      
      match /documents/{documentId} {
        allow read: if canReadEngagement(engagementId);
        
        // Most team members can upload documents
        allow create: if canReadEngagement(engagementId);
        
        // Only uploader or managers can update
        allow update: if canManageEngagement(engagementId) ||
                         resource.data.uploadedBy == request.auth.uid;
        
        // Only managers can delete
        allow delete: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Activity Log Subcollection (Audit trail)
      // ----------------------------------------
      
      match /activityLog/{logId} {
        // Everyone on team can read
        allow read: if canReadEngagement(engagementId);
        
        // Only system/cloud functions create logs
        allow create: if false; // Use cloud functions
        
        // No updates or deletes
        allow update, delete: if false;
      }
    }
    
    // ----------------------------------------
    // Clients Collection
    // ----------------------------------------
    
    match /clients/{clientId} {
      // For testing/development: allow all authenticated users
      // TODO: Tighten rules after role system is fully operational
      allow read, write: if isAuthenticated();
      
      // Contacts subcollection
      match /contacts/{contactId} {
        allow read, write: if isAuthenticated();
      }
      
      // KYC Documents subcollection
      match /kycDocuments/{kycDocId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ----------------------------------------
    // Funders Collection
    // ----------------------------------------
    
    match /funders/{funderId} {
      // Platform staff can read all funders
      // Funder users can read their own funder
      allow read: if isPlatformStaff() || isFunderAssociated(funderId);
      
      // Only admins can manage funders
      allow create, update: if isPlatformAdmin();
      
      allow delete: if hasPlatformRole('super_admin');
    }
    
    // ============================================
    // ADVISORY PLATFORM COLLECTIONS
    // Nested collection structure for advisory modules
    // ============================================
    
    // Advisory module collections
    match /advisoryPlatform/{module}/{collection}/{docId} {
      allow read, write: if isAuthenticated();
      
      // Subcollections
      match /{subcollection}/{subDocId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Mandates collection (root level)
    match /mandates/{mandateId} {
      allow read, write: if isAuthenticated();
    }
    
    // Risk Assessments collection (root level)
    match /riskAssessments/{assessmentId} {
      allow read, write: if isAuthenticated();
    }
    
    // Portfolios collection (root level)
    match /portfolios/{portfolioId} {
      allow read, write: if isAuthenticated();
      
      // NAV History subcollection
      match /navHistory/{navId} {
        allow read, write: if isAuthenticated();
      }
      
      // Capital Transactions subcollection
      match /capitalTransactions/{transactionId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Holdings collection (root level)
    match /holdings/{holdingId} {
      allow read, write: if isAuthenticated();
      
      // Valuations subcollection
      match /valuations/{valuationId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ============================================
    // DAWINOS v2.0 - ENTERPRISE OPERATIONS PLATFORM
    // ============================================
    
    // v2.0 Helper Functions
    function getClaims() {
      return request.auth.token;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getClaims().role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getClaims().role in roles;
    }
    
    function isExecutive() {
      return hasAnyRole(['platform_admin', 'ceo', 'executive', 'director']);
    }
    
    function isHR() {
      return hasAnyRole(['platform_admin', 'hr_admin', 'hr_manager']);
    }
    
    function isFinance() {
      return hasAnyRole(['platform_admin', 'finance_admin', 'finance_manager', 'accountant']);
    }
    
    function belongsToSubsidiary(subsidiaryId) {
      return isAuthenticated() && getClaims().subsidiaryId == subsidiaryId;
    }
    
    function hasSubsidiaryAccess(subsidiaryId) {
      return isAdmin() || isExecutive() || belongsToSubsidiary(subsidiaryId);
    }
    
    function hasSubsidiaryWriteAccess(subsidiaryId) {
      return isAdmin() || (belongsToSubsidiary(subsidiaryId) && 
        hasAnyRole(['subsidiary_admin', 'manager', 'team_lead']));
    }
    
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    function isCreator() {
      return isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    function hasValidTimestamps() {
      return request.resource.data.createdAt == resource.data.createdAt &&
             request.resource.data.updatedAt == request.time;
    }
    
    // Note: hasRequiredFields is already defined above at line ~520
    // Use hasRequiredFields(request.resource.data, fields) for v2.0 rules
    
    // ----------------------------------------
    // Platform Configuration
    // ----------------------------------------
    
    match /platform/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /platform/config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ----------------------------------------
    // Executive Layer
    // ----------------------------------------
    
    // Strategy Documents
    match /executive/strategy/documents/{docId} {
      allow read: if isExecutive();
      allow create: if isExecutive() && 
        hasRequiredFields(request.resource.data, ['title', 'content', 'createdBy', 'createdAt']);
      allow update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    // OKRs
    match /executive/strategy/okrs/{okrId} {
      allow read: if isAuthenticated();
      allow create: if isExecutive() && 
        hasRequiredFields(request.resource.data, ['title', 'level', 'ownerId', 'period']);
      allow update: if isExecutive() || 
        (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    // KPIs
    match /executive/strategy/kpis/{kpiId} {
      allow read: if isAuthenticated();
      allow create, update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    // Market Intelligence
    match /executive/market_intelligence/{collection}/{docId} {
      allow read: if isExecutive();
      allow create, update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    // Capital Hub
    match /executive/capital/raises/{raiseId} {
      allow read: if isExecutive();
      allow create: if isExecutive() && 
        hasRequiredFields(request.resource.data, ['name', 'type', 'targetAmount', 'status']);
      allow update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    match /executive/capital/investors/{investorId} {
      allow read: if isExecutive();
      allow create, update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    match /executive/capital/allocations/{allocId} {
      allow read: if isExecutive() || isFinance();
      allow create, update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    // Strategic Opportunities & Needs
    match /executive/opportunities/{collection}/{docId} {
      allow read: if isExecutive();
      allow create, update: if isExecutive();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Shared Operations
    // ----------------------------------------
    
    // Smart Tasks
    match /shared_ops/smart_tasks/{taskId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.assignedTo == request.auth.uid ||
        resource.data.createdBy == request.auth.uid ||
        resource.data.delegatedBy == request.auth.uid
      );
      
      allow create: if isAuthenticated() && 
        hasRequiredFields(request.resource.data, ['title', 'status', 'createdBy', 'createdAt']);
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.assignedTo == request.auth.uid ||
        isCreator()
      );
      
      allow delete: if isAdmin() || isCreator();
    }
    
    // Business Events
    match /shared_ops/business_events/{eventId} {
      allow read: if isAuthenticated() && (
        isAdmin() || hasAnyRole(['manager', 'team_lead', 'executive'])
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Finance Batches
    match /shared_ops/finance_batches/{batchId} {
      allow read: if isFinance();
      allow create: if isFinance() && 
        hasRequiredFields(request.resource.data, ['uploadedBy', 'uploadedAt', 'status']);
      allow update: if isFinance();
      allow delete: if isAdmin();
      
      match /transactions/{transactionId} {
        allow read: if isFinance();
        allow create, update: if isFinance();
        allow delete: if isAdmin();
      }
    }
    
    // Knowledge Base
    match /shared_ops/knowledge_base/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isHR() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Grey Areas
    match /shared_ops/grey_areas/{areaId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isExecutive() || isHR() ||
        resource.data.assignedTo == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin() || isHR() || 
        resource.data.assignedTo == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // HR Module
    // ----------------------------------------
    
    // Counters for employee number generation
    match /counters/{counterId} {
      allow read, write: if isAuthenticated();
    }
    
    // Employees (root-level collection for HR Central module)
    match /employees/{employeeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // TODO: Restrict to isHR() after roles are configured
      allow update: if isAuthenticated(); // Allow updates for now
      allow delete: if isAdmin();
      
      // Audit subcollection
      match /audit/{auditId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false;
      }
    }
    
    // Employees (legacy nested path)
    match /hr/employees/{employeeId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() || resource.data.userId == request.auth.uid
      );
      allow create: if isHR() && 
        hasRequiredFields(request.resource.data, ['personalInfo', 'employment', 'status']);
      allow update: if isHR() || (
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['contact', 'emergencyContact', 'updatedAt'])
      );
      allow delete: if isAdmin();
    }
    
    // Employment Contracts
    match /hr/contracts/{contractId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() || resource.data.employeeId == request.auth.uid
      );
      allow create, update: if isHR();
      allow delete: if isAdmin();
    }
    
    // Payroll Batches - Highly restricted, never delete
    match /hr/payroll_batches/{batchId} {
      allow read: if isHR() || isFinance() || isAdmin();
      allow create, update: if isHR();
      allow delete: if false;
      
      match /items/{itemId} {
        allow read: if isHR() || isFinance() || 
          resource.data.employeeId == request.auth.uid;
        allow create, update: if isHR();
        allow delete: if false;
      }
    }
    
    // Leave Requests
    match /hr/leave_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() || resource.data.employeeId == request.auth.uid
      );
      allow create: if isAuthenticated() && 
        request.resource.data.employeeId == request.auth.uid &&
        hasRequiredFields(request.resource.data, ['employeeId', 'leaveType', 'startDate', 'endDate']);
      allow update: if isHR();
      allow delete: if isAdmin();
    }
    
    // Performance Reviews
    match /hr/performance/{reviewId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.reviewerId == request.auth.uid
      );
      allow create: if isHR();
      allow update: if isHR() || resource.data.reviewerId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Departments & Role Profiles
    match /hr/departments/{deptId} {
      allow read: if isAuthenticated();
      allow create, update: if isHR() || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /hr/role_profiles/{profileId} {
      allow read: if isAuthenticated();
      allow create, update: if isHR() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Payroll Records (Attendance, Advances, Overtime)
    // ----------------------------------------
    
    // Attendance Records
    match /attendance/{recordId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isHR() || isAdmin();
    }
    
    // Salary Advances
    match /salaryAdvances/{advanceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Overtime Entries
    match /overtime/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isHR() || isAdmin();
    }
    
    // ----------------------------------------
    // Finance Module
    // ----------------------------------------
    
    // Budgets
    match /budgets/{budgetId} {
      allow read: if isAuthenticated();
      allow create, update: if isFinance() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Expenses
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isFinance() || resource.data.submittedBy == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isFinance() || resource.data.submittedBy == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Financial Reports
    match /financial_reports/{reportId} {
      allow read: if isAuthenticated() && (isFinance() || isExecutive() || isAdmin());
      allow create, update: if isFinance();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Performance Module
    // ----------------------------------------
    
    // Goals
    match /goals/{goalId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.managerId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isHR() || 
        resource.data.employeeId == request.auth.uid ||
        resource.data.managerId == request.auth.uid;
      allow delete: if isAdmin() || isHR();
    }
    
    // Reviews
    match /reviews/{reviewId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.reviewerId == request.auth.uid
      );
      allow create: if isHR() || isAuthenticated();
      allow update: if isHR() || resource.data.reviewerId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Competencies
    match /competencies/{competencyId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated(); // Allow all authenticated users (for seeding and development)
      allow delete: if isAdmin();
    }

    // Employee Competencies (assessments/skill levels)
    match /employee_competencies/{recordId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid
      );
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin() || isHR();
    }

    // Competency Assessments
    match /competency_assessments/{assessmentId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.assessorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isHR() || resource.data.assessorId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Training Courses
    match /training_courses/{courseId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated(); // Allow all authenticated users (for catalog management)
      allow delete: if isAdmin() || isHR();
    }

    // Employee Training (enrollments and progress)
    match /employee_training/{enrollmentId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        isHR() ||
        resource.data.employeeId == request.auth.uid
      );
      allow delete: if isAdmin() || isHR();
    }

    // Development Plans
    match /development_plans/{planId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.managerId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.managerId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Development Activities
    match /development_activities/{activityId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin() || isHR();
    }

    // Performance Metrics
    match /performance_metrics/{metricId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isHR() ||
        resource.data.employeeId == request.auth.uid ||
        resource.data.managerId == request.auth.uid
      );
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin() || isHR();
    }
    
    // ----------------------------------------
    // Advisory Module Collections
    // ----------------------------------------
    
    // Deals
    match /deals/{dealId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Programs
    // Note: Read access is public to support CD Portal (unauthenticated token-based access)
    match /programs/{programId} {
      allow read: if true;
      allow create, update, delete: if isAuthenticated();
      
      // Activity log for programs
      match /activityLog/{logId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }
    
    // Projects (Delivery Projects)
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
      
      // Activity log for projects
      match /activityLog/{logId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
      
      // Control BOQ Items (subcollection)
      match /boq_items/{itemId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
      
      // Control BOQ Document (subcollection)
      match /control_boq/{docId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAdmin();
      }
    }
    
    // BOQ Items (root-level collection for cross-project queries)
    match /boq_items/{itemId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Control BOQ Items (root-level collection with projectId field)
    match /control_boq/{itemId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // IPCs (Interim Payment Certificates)
    match /ipcs/{ipcId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Payments Collection (unified for IPCs, Requisitions, Accountabilities)
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        // Creator can update drafts
        (resource.data.createdBy == request.auth.uid && resource.data.status == 'draft') ||
        // Approvers can update status
        isFinance() ||
        hasAnyRole(['project_manager', 'program_manager', 'quantity_surveyor', 'site_engineer', 'finance_director', 'country_coordinator'])
      );
      allow delete: if isAdmin();
    }
    
    // Requisitions
    match /requisitions/{requisitionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Manual Requisitions (for manual entry without BOQ)
    // Note: Read access is public to support CD Portal (unauthenticated token-based access)
    // Data is filtered by programId in the portal service
    match /manual_requisitions/{requisitionId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ----------------------------------------
    // CD Portal Access Tokens
    // Token-based access for Country Director Portal
    // ----------------------------------------

    // Portal Access Tokens
    // Note: Read access is public to allow unauthenticated token validation
    // Security is provided by the 32-char cryptographic token itself
    match /portal_access_tokens/{tokenId} {
      // Allow unauthenticated read for portal token validation
      allow read: if true;
      // Only authenticated users can create tokens
      allow create: if isAuthenticated();
      // Only authenticated users can update tokens (activate/deactivate)
      allow update: if isAuthenticated();
      // Only admin or authenticated users can delete tokens
      allow delete: if isAdmin() || isAuthenticated();
    }

    // ----------------------------------------
    // Funds Acknowledgement Collections
    // ----------------------------------------

    // Receipt Sequences (atomic counters for receipt numbers)
    match /receipt_sequences/{sequenceId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Funds Acknowledgement Documents
    // Note: Read access is public to support CD Portal (unauthenticated token-based access)
    match /funds_acknowledgements/{docId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Facility Configurations (shared branding across projects)
    match /facility_configurations/{configId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Accountability Reports
    match /accountability_reports/{reportId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Investment Committee Meetings
    match /investment_committee_meetings/{meetingId} {
      allow read: if isAuthenticated();
      allow create, update: if isExecutive() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Market Insights
    match /market_insights/{insightId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Admin Module Collections
    // ----------------------------------------
    
    // Roles
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // System Settings
    match /system_settings/{settingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Organizations & Branding
    // ----------------------------------------
    
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      // Organization settings (branding, etc.)
      match /settings/{settingId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Organization users
      match /users/{userId} {
        allow read: if isAuthenticated();
        // Admins can perform all write operations
        allow create, delete: if isAdmin();
        // Admins can update any field; non-admins can only update their own profile fields
        allow update: if isAdmin()
          || (isAuthenticated()
              && resource.data.uid == request.auth.uid
              && request.resource.data.diff(resource.data).affectedKeys()
                .hasOnly(['displayName', 'phone', 'jobTitle', 'department', 'photoUrl', 'lastLoginAt', 'updatedAt']));
      }
      
      // Organization invites
      match /invites/{inviteId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      // Organization audit log
      match /auditLog/{logId} {
        allow read: if isAdmin();
        allow create: if isAuthenticated();
        allow update, delete: if false;
      }

      // Advisory Projects (Core Project Service)
      // Note: Read access is public to support CD Portal (unauthenticated token-based access)
      match /advisory_projects/{projectId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();

        // Activity log for advisory projects
        match /activityLog/{logId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update, delete: if false;
        }
      }

      // Advisory Programs
      // Note: Read access is public to support CD Portal (unauthenticated token-based access)
      match /advisory_programs/{programId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }

      // Report Templates (Google Docs report generation)
      match /report_templates/{templateId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAdmin();
      }

      // Generated Reports (report history and metadata)
      match /generated_reports/{reportId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAdmin();
      }
    }
    
    // ----------------------------------------
    // Audit Logs - Write-only, never delete
    // ----------------------------------------
    
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // ----------------------------------------
    // User Preferences & Settings
    // ----------------------------------------
    
    match /user_settings/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    match /user_notifications/{userId}/{notificationId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated();
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // INTELLIGENCE LAYER COLLECTIONS
    // AI-powered cross-module intelligence
    // ============================================
    
    // ----------------------------------------
    // Smart Suggestions
    // ----------------------------------------
    
    match /smartSuggestions/{suggestionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Anomaly Detection
    // ----------------------------------------
    
    match /anomalies/{anomalyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Predictions
    // ----------------------------------------
    
    match /predictions/{predictionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Cross-Module Insights
    // ----------------------------------------
    
    match /crossModuleInsights/{insightId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Intelligence Activity Log
    // ----------------------------------------
    
    match /intelligenceActivity/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // AI Assistant Conversations
    // ----------------------------------------
    
    match /assistantConversations/{conversationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if false;
        allow delete: if isAdmin();
      }
    }
    
    // ----------------------------------------
    // Natural Language Queries
    // ----------------------------------------
    
    match /nlQueries/{queryId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ----------------------------------------
    // Document Analyses
    // ----------------------------------------
    
    match /documentAnalyses/{analysisId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Category Suggestions (Auto-categorization)
    // ----------------------------------------
    
    match /categorySuggestions/{suggestionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Intelligence Configuration
    // ----------------------------------------
    
    match /intelligenceConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ----------------------------------------
    // AI Model Usage Tracking
    // ----------------------------------------
    
    match /aiModelUsage/{usageId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ----------------------------------------
    // Business Events (Cross-Module)
    // ----------------------------------------
    
    match /businessEvents/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Task Templates (Admin-managed)
    // ----------------------------------------
    
    match /taskTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Generated Tasks (AI-created tasks)
    // ----------------------------------------
    
    match /generatedTasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Task Dependencies
    // ----------------------------------------

    match /taskDependencies/{dependencyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ============================================
    // STRATEGY MODULE COLLECTIONS
    // CEO Strategy & Performance Management
    // ============================================

    // ----------------------------------------
    // Strategy Documents
    // ----------------------------------------

    match /strategy_documents/{docId} {
      allow read: if isAuthenticated();
      allow create: if isExecutive() || hasAnyRole(['strategy_manager']);
      allow update: if isExecutive() || hasAnyRole(['strategy_manager']) ||
                       resource.data.createdBy == request.auth.uid;
      allow delete: if hasPlatformRole('super_admin');
    }

    // ----------------------------------------
    // OKR Objectives
    // ----------------------------------------

    match /okr_objectives/{objId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Users can create their own OKRs
      allow update: if isExecutive() || hasAnyRole(['manager', 'strategy_manager']) ||
                       resource.data.ownerId == request.auth.uid;
      allow delete: if isExecutive() || resource.data.ownerId == request.auth.uid;

      // Key Results subcollection
      match /key_results/{krId} {
        allow read: if isAuthenticated();
        allow create, update: if isExecutive() || hasAnyRole(['manager']) ||
                                 get(/databases/$(database)/documents/okr_objectives/$(objId)).data.ownerId == request.auth.uid;
        allow delete: if isExecutive() ||
                         get(/databases/$(database)/documents/okr_objectives/$(objId)).data.ownerId == request.auth.uid;
      }
    }

    // ----------------------------------------
    // KPI Definitions
    // ----------------------------------------

    match /kpi_definitions/{kpiId} {
      allow read: if isAuthenticated();
      allow create, update: if isExecutive() || hasAnyRole(['strategy_manager']);
      allow delete: if isAdmin() || hasPlatformRole('super_admin');
    }

    // ----------------------------------------
    // KPI Data Points
    // ----------------------------------------

    match /kpi_data_points/{dataId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Data entry by authorized users
      allow update: if isExecutive() || hasAnyRole(['strategy_manager']) ||
                       resource.data.recordedBy == request.auth.uid;
      allow delete: if isAdmin() || hasPlatformRole('super_admin');
    }

    // ----------------------------------------
    // Performance Snapshots
    // ----------------------------------------

    match /performance_snapshots/{snapId} {
      allow read: if isAuthenticated();
      allow create, update: if isExecutive() || hasAnyRole(['strategy_manager', 'system']); // System-generated
      allow delete: if isAdmin() || hasPlatformRole('super_admin');
    }
  }
}
