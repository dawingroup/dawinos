rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/designProjects/$(projectId)).data;
      return isAuthenticated() && (
        project.createdBy == request.auth.token.email ||
        project.assignedDesigner == request.auth.token.email ||
        project.assignedEngineer == request.auth.token.email ||
        isAdmin()
      );
    }
    
    // ============================================
    // Cutlist Processor Collections
    // ============================================
    
    // Work Instances collection
    match /workInstances/{instanceId} {
      allow read, write: if isAuthenticated();
    }
    
    // Material Mappings
    match /materialMappings/{mappingId} {
      allow read, write: if isAuthenticated();
    }
    
    // Stock Materials
    match /stockMaterials/{materialId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // Material Library Collections
    // ============================================
    
    // Global materials (admin managed)
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // ============================================
    // Customer Hub Collections
    // ============================================
    
    // Customers collection
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update from authenticated users OR service accounts (for Cloud Functions)
      allow update, delete: if isAuthenticated() || request.auth == null;
      
      // Customer-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
      
      // Customer Projects subcollection (future)
      match /projects/{projectId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ============================================
    // Design Manager Collections
    // ============================================
    
    // Design Projects
    match /designProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isProjectMember(projectId);
      
      // Project-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Design Items (subcollection)
      match /designItems/{itemId} {
        allow read: if isAuthenticated();
        allow create, update: if isProjectMember(projectId);
        allow delete: if isAdmin();
        
        // Stage History (append-only audit trail)
        match /stageHistory/{historyId} {
          allow read: if isAuthenticated();
          allow create: if isProjectMember(projectId);
          allow update, delete: if false; // Immutable audit trail
        }
        
        // Approvals
        match /approvals/{approvalId} {
          allow read: if isAuthenticated();
          allow create: if isProjectMember(projectId);
          allow update: if isAuthenticated() && 
            resource.data.assignedTo == request.auth.token.email;
          allow delete: if isAdmin();
        }
        
        // Deliverables
        match /deliverables/{deliverableId} {
          allow read: if isAuthenticated();
          allow create, update: if isProjectMember(projectId);
          allow delete: if isAdmin();
        }
      }
      
      // AI Analyses (project-level)
      match /aiAnalyses/{analysisId} {
        allow read: if isAuthenticated();
        allow create: if isProjectMember(projectId);
        allow update: if isAuthenticated() && 
          resource.data.requestedBy == request.auth.token.email;
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // User Management
    // ============================================
    
    // Users collection (for role-based access)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    // ============================================
    // Error Logging (Design Manager)
    // ============================================
    
    match /designManagerErrors/{errorId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // AI Features Collections
    // ============================================
    
    // Project Strategy (Strategy Canvas)
    match /projectStrategy/{projectId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Feature Library
    match /featureLibrary/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Design Item AI Conversations
    match /designItemConversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Product Roadmap
    match /roadmapProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Product Sync Mappings (Shopify)
    match /productSyncMappings/{mappingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Rate Limiting (managed by Cloud Functions)
    match /rateLimits/{userId} {
      allow read, write: if true; // Cloud Functions manage this
    }
    
    // System Config (Feature Library cache, etc.)
    match /systemConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions manage this
    }
  }
}
