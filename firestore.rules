rules_version = '2';

// ============================================
// DawinOS - Dawin Finishes
// Firestore Security Rules
// ============================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/designProjects/$(projectId)).data;
      return isAuthenticated() && (
        project.createdBy == request.auth.token.email ||
        project.assignedDesigner == request.auth.token.email ||
        project.assignedEngineer == request.auth.token.email ||
        isAdmin()
      );
    }
    
    // ============================================
    // Cutlist Processor Collections
    // ============================================
    
    // Work Instances collection
    match /workInstances/{instanceId} {
      allow read, write: if isAuthenticated();
    }
    
    // Material Mappings
    match /materialMappings/{mappingId} {
      allow read, write: if isAuthenticated();
    }
    
    // Stock Materials
    match /stockMaterials/{materialId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // Material Library Collections
    // ============================================
    
    // Global materials (admin managed)
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    match /katanaCatalogItems/{itemId} {
      allow read, write: if isAuthenticated();
    }

    // Unified Inventory (single source of truth for materials)
    match /inventoryItems/{itemId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // ============================================
    // Customer Hub Collections
    // ============================================
    
    // Customers collection
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update from authenticated users OR service accounts (for Cloud Functions)
      allow update, delete: if isAuthenticated() || request.auth == null;
      
      // Customer-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
      
      // Customer Projects subcollection (future)
      match /projects/{projectId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ============================================
    // Design Manager Collections
    // ============================================
    
    // Design Projects
    match /designProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow any authenticated user to update (for optimization, palette, etc.)
      allow update: if isAuthenticated();
      allow delete: if isProjectMember(projectId);
      
      // Project-specific materials
      match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Project Parts Library (shared special parts across design items)
      match /projectParts/{partId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
      }
      
      // Design Items (subcollection)
      match /designItems/{itemId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isProjectMember(projectId);
        
        // Stage History (append-only audit trail)
        match /stageHistory/{historyId} {
          allow read: if isAuthenticated();
          allow create: if isProjectMember(projectId);
          allow update, delete: if false; // Immutable audit trail
        }
        
        // Approvals
        match /approvals/{approvalId} {
          allow read: if isAuthenticated();
          allow create, delete: if isProjectMember(projectId);
          allow update: if isAuthenticated() && 
            resource.data.assignedTo == request.auth.token.email;
        }
        
        // Deliverables
        match /deliverables/{deliverableId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isProjectMember(projectId);
        }
      }
      
      // AI Analyses (project-level)
      match /aiAnalyses/{analysisId} {
        allow read: if isAuthenticated();
        allow create: if isProjectMember(projectId);
        allow update: if isAuthenticated() && 
          resource.data.requestedBy == request.auth.token.email;
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // User Management
    // ============================================
    
    // Users collection (for role-based access)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    // ============================================
    // Error Logging (Design Manager)
    // ============================================
    
    match /designManagerErrors/{errorId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // Asset Registry Collections
    // ============================================
    
    // Assets collection
    match /assets/{assetId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Features collection
    match /features/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // AI Features Collections
    // ============================================
    
    // Project Strategy (Strategy Canvas)
    match /projectStrategy/{projectId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Feature Library
    match /featureLibrary/{featureId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Design Item AI Conversations
    match /designItemConversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // AI Chat History (Strategy Research, Design Item Enhancement, etc.)
    match /aiChats/{chatId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // AI Context (change detection for AI tools)
    match /aiContext/{contextId} {
      allow read, write: if isAuthenticated();
    }
    
    // Product Roadmap
    match /roadmapProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Launch Pipeline Products
    match /launchProducts/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Product Sync Mappings (Shopify)
    match /productSyncMappings/{mappingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Rate Limiting (managed by Cloud Functions)
    match /rateLimits/{userId} {
      allow read, write: if true; // Cloud Functions manage this
    }
    
    // System Config (Feature Library cache, etc.)
    match /systemConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if true; // Cloud Functions manage this
    }
    
    // ============================================
    // Design Clipper Collections
    // ============================================
    
    // Design Clips (inspiration capture from Chrome extension)
    // Uses user UID for createdBy field
    // Allow reading clips that belong to user OR are linked to a design item/project
    match /designClips/{clipId} {
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        resource.data.designItemId != null ||
        resource.data.projectId != null
      );
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
    }
    
    // ============================================
    // MATFLOW - Dawin Advisory
    // Construction Material Management
    // ============================================
    
    // Helper: Get user's organization ID
    function getUserOrg() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId;
    }
    
    // Helper: Check if user is org member
    function isOrgMember(orgId) {
      return isAuthenticated() && getUserOrg() == orgId;
    }
    
    // Helper: Check if user is MatFlow project member
    function isMatFlowProjectMember(orgId, projectId) {
      let project = get(/databases/$(database)/documents/organizations/$(orgId)/matflow_projects/$(projectId)).data;
      let userId = request.auth.uid;
      let userEmail = request.auth.token.email;
      
      return isOrgMember(orgId) && (
        project.createdBy == userId ||
        userId in project.memberIds
      );
    }
    
    // Helper: Check MatFlow capability
    function hasMatFlowCapability(orgId, projectId, capability) {
      let project = get(/databases/$(database)/documents/organizations/$(orgId)/matflow_projects/$(projectId)).data;
      let userId = request.auth.uid;
      
      // Check if user has capability in their member entry
      return userId in project.memberCapabilities && 
        capability in project.memberCapabilities[userId];
    }
    
    // ----------------------------------------
    // Global MatFlow Collections
    // ----------------------------------------
    
    // Standard Formulas - Read by all authenticated, write by admins
    match /matflow/data/formulas/{formulaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Material Rates - Read by all authenticated, write by admins
    match /matflow/data/material_rates/{rateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Role Definitions - Read by all authenticated, write by admins
    match /matflow/data/roles/{roleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ----------------------------------------
    // Organization MatFlow Projects
    // ----------------------------------------
    
    match /organizations/{orgId}/matflow_projects/{projectId} {
      // Read: Org members can list, project members can read details
      allow list: if isOrgMember(orgId);
      allow get: if isMatFlowProjectMember(orgId, projectId);
      
      // Create: Org members can create projects
      allow create: if isOrgMember(orgId) && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Update: Project members with edit capability
      allow update: if isMatFlowProjectMember(orgId, projectId) &&
        hasMatFlowCapability(orgId, projectId, 'project:edit');
      
      // Delete: Only admins or project owners
      allow delete: if isAdmin() || 
        (isMatFlowProjectMember(orgId, projectId) && 
         resource.data.createdBy == request.auth.uid);
      
      // ----------------------------------------
      // BOQ Items Subcollection
      // ----------------------------------------
      
      match /boq_items/{itemId} {
        allow read: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:view');
        
        allow create: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:create');
        
        allow update: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:edit');
        
        allow delete: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:delete');
      }
      
      // ----------------------------------------
      // Procurement Entries Subcollection
      // ----------------------------------------
      
      match /procurement_entries/{entryId} {
        allow read: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:view');
        
        allow create: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:create');
        
        allow update: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:edit');
        
        allow delete: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'procurement:delete');
      }
      
      // ----------------------------------------
      // Parsing Jobs Subcollection
      // ----------------------------------------
      
      match /parsing_jobs/{jobId} {
        allow read: if isMatFlowProjectMember(orgId, projectId);
        
        allow create: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:import');
        
        allow update: if isMatFlowProjectMember(orgId, projectId) &&
          hasMatFlowCapability(orgId, projectId, 'boq:import');
        
        // Jobs are never deleted, only marked as completed/failed
        allow delete: if false;
      }
    }
    
    // ============================================
    // DAWIN ADVISORY PLATFORM
    // Engagement-centric architecture
    // ============================================
    
    // ----------------------------------------
    // Advisory Helper Functions
    // ----------------------------------------
    
    // Get user document for advisory
    function getAdvisoryUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check platform role
    function hasPlatformRole(role) {
      return isAuthenticated() && getAdvisoryUserDoc().platformRole == role;
    }
    
    // Check if user is platform admin
    function isPlatformAdmin() {
      return hasPlatformRole('super_admin') || hasPlatformRole('admin');
    }
    
    // Check if user is platform staff (any staff role)
    function isPlatformStaff() {
      let user = getAdvisoryUserDoc();
      return user.platformRole in ['super_admin', 'admin', 'manager', 'staff'];
    }
    
    // Get user's role in an engagement
    function getEngagementRole(engagementId) {
      let user = getAdvisoryUserDoc();
      return user.engagementRoles[engagementId];
    }
    
    // Check if user has role in engagement
    function hasEngagementRole(engagementId, allowedRoles) {
      let role = getEngagementRole(engagementId);
      return role != null && role in allowedRoles;
    }
    
    // Check if user is engagement owner or lead
    function isEngagementLeadership(engagementId) {
      return hasEngagementRole(engagementId, ['engagement_owner', 'engagement_lead']);
    }
    
    // Check if user can read engagement
    function canReadEngagement(engagementId) {
      return isPlatformAdmin() || getEngagementRole(engagementId) != null;
    }
    
    // Check if user can write to engagement
    function canWriteEngagement(engagementId) {
      return isPlatformAdmin() || hasEngagementRole(engagementId, [
        'engagement_owner', 
        'engagement_lead',
        'program_manager',
        'deal_lead',
        'portfolio_manager',
        'project_manager',
        'finance_officer',
        'compliance_officer'
      ]);
    }
    
    // Check if user can manage engagement (update settings, team)
    function canManageEngagement(engagementId) {
      return isPlatformAdmin() || isEngagementLeadership(engagementId);
    }
    
    // Check if user can approve in engagement
    function canApproveInEngagement(engagementId) {
      return hasEngagementRole(engagementId, [
        'engagement_owner',
        'engagement_lead',
        'program_manager',
        'project_manager',
        'deal_lead',
        'portfolio_manager',
        'finance_officer'
      ]);
    }
    
    // Check if user is associated with a client
    function isClientAssociated(clientId) {
      let user = getAdvisoryUserDoc();
      return user.clientAssociations != null && 
             clientId in user.clientAssociations;
    }
    
    // Check if user is associated with a funder
    function isFunderAssociated(funderId) {
      let user = getAdvisoryUserDoc();
      return user.funderAssociations != null && 
             funderId in user.funderAssociations;
    }
    
    // Validate required fields exist
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }
    
    // ----------------------------------------
    // Engagements Collection
    // ----------------------------------------
    
    match /engagements/{engagementId} {
      // Read: Team members and admins
      allow read: if canReadEngagement(engagementId);
      
      // Create: Admins and managers
      allow create: if isPlatformAdmin() || hasPlatformRole('manager');
      
      // Update: Engagement leadership and admins
      allow update: if canManageEngagement(engagementId);
      
      // Delete: Only super admins
      allow delete: if hasPlatformRole('super_admin');
      
      // ----------------------------------------
      // Funding Sources Subcollection
      // ----------------------------------------
      
      match /fundingSources/{fundingSourceId} {
        allow read: if canReadEngagement(engagementId);
        
        allow create: if canWriteEngagement(engagementId) &&
                         hasRequiredFields(request.resource.data, 
                           ['category', 'instrumentType', 'funderId', 'committedAmount']);
        
        allow update: if canWriteEngagement(engagementId);
        
        allow delete: if canManageEngagement(engagementId);
        
        // Disbursements subcollection
        match /disbursements/{disbursementId} {
          allow read: if canReadEngagement(engagementId);
          
          allow create: if canWriteEngagement(engagementId) &&
                           hasRequiredFields(request.resource.data,
                             ['requestedAmount', 'description']);
          
          allow update: if canWriteEngagement(engagementId) ||
                           // Funder can update status
                           isFunderAssociated(get(/databases/$(database)/documents/engagements/$(engagementId)/fundingSources/$(fundingSourceId)).data.funderId);
          
          allow delete: if canManageEngagement(engagementId);
        }
      }
      
      // ----------------------------------------
      // Reporting Requirements Subcollection
      // ----------------------------------------
      
      match /reportingRequirements/{requirementId} {
        allow read: if canReadEngagement(engagementId);
        allow write: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Report Submissions Subcollection
      // ----------------------------------------
      
      match /reportSubmissions/{submissionId} {
        allow read: if canReadEngagement(engagementId);
        
        allow create: if canWriteEngagement(engagementId);
        
        // Can update own submissions or if approver
        allow update: if canWriteEngagement(engagementId) ||
                         (resource.data.submittedBy == request.auth.uid);
        
        allow delete: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Covenants Subcollection
      // ----------------------------------------
      
      match /covenants/{covenantId} {
        allow read: if canReadEngagement(engagementId);
        
        allow create, update: if canManageEngagement(engagementId) ||
                                 hasEngagementRole(engagementId, ['compliance_officer', 'finance_officer']);
        
        allow delete: if canManageEngagement(engagementId);
        
        // Measurements subcollection
        match /measurements/{measurementId} {
          allow read: if canReadEngagement(engagementId);
          
          allow create: if hasEngagementRole(engagementId, [
            'engagement_owner', 'engagement_lead', 'compliance_officer', 'finance_officer'
          ]);
          
          allow update: if canManageEngagement(engagementId);
          
          allow delete: if canManageEngagement(engagementId);
        }
      }
      
      // ----------------------------------------
      // Approval Requests Subcollection
      // ----------------------------------------
      
      match /approvalRequests/{requestId} {
        allow read: if canReadEngagement(engagementId);
        
        // Anyone on the team can create approval requests
        allow create: if canWriteEngagement(engagementId) ||
                         hasEngagementRole(engagementId, ['team_member', 'quantity_surveyor', 'site_manager']);
        
        // Can update if you're an approver or the requester (for cancellation)
        allow update: if canApproveInEngagement(engagementId) ||
                         resource.data.requestedBy == request.auth.uid;
        
        allow delete: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Documents Subcollection
      // ----------------------------------------
      
      match /documents/{documentId} {
        allow read: if canReadEngagement(engagementId);
        
        // Most team members can upload documents
        allow create: if canReadEngagement(engagementId);
        
        // Only uploader or managers can update
        allow update: if canManageEngagement(engagementId) ||
                         resource.data.uploadedBy == request.auth.uid;
        
        // Only managers can delete
        allow delete: if canManageEngagement(engagementId);
      }
      
      // ----------------------------------------
      // Activity Log Subcollection (Audit trail)
      // ----------------------------------------
      
      match /activityLog/{logId} {
        // Everyone on team can read
        allow read: if canReadEngagement(engagementId);
        
        // Only system/cloud functions create logs
        allow create: if false; // Use cloud functions
        
        // No updates or deletes
        allow update, delete: if false;
      }
    }
    
    // ----------------------------------------
    // Clients Collection
    // ----------------------------------------
    
    match /clients/{clientId} {
      // Platform staff can read all clients
      // Client users can read their own client
      allow read: if isPlatformStaff() || isClientAssociated(clientId);
      
      // Only admins and managers can create clients
      allow create: if isPlatformAdmin() || hasPlatformRole('manager');
      
      // Relationship managers and admins can update
      allow update: if isPlatformAdmin() ||
                       request.auth.uid == resource.data.relationshipManagerId;
      
      // Only super admins can delete
      allow delete: if hasPlatformRole('super_admin');
      
      // Contacts subcollection
      match /contacts/{contactId} {
        allow read: if isPlatformStaff() || isClientAssociated(clientId);
        
        allow create, update: if isPlatformStaff();
        
        allow delete: if isPlatformAdmin();
      }
      
      // KYC Documents subcollection
      match /kycDocuments/{kycDocId} {
        allow read: if isPlatformStaff() || isClientAssociated(clientId);
        
        allow create: if isPlatformStaff() || isClientAssociated(clientId);
        
        // Only compliance can verify
        allow update: if isPlatformAdmin() || hasPlatformRole('manager');
        
        allow delete: if isPlatformAdmin();
      }
    }
    
    // ----------------------------------------
    // Funders Collection
    // ----------------------------------------
    
    match /funders/{funderId} {
      // Platform staff can read all funders
      // Funder users can read their own funder
      allow read: if isPlatformStaff() || isFunderAssociated(funderId);
      
      // Only admins can manage funders
      allow create, update: if isPlatformAdmin();
      
      allow delete: if hasPlatformRole('super_admin');
    }
  }
}
